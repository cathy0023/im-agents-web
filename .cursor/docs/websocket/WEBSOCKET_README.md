# WebSocket ç³»ç»Ÿæ¶æ„æ–‡æ¡£

## ğŸ“‹ ç›®å½•
- [ç³»ç»Ÿæ¦‚è¿°](#ç³»ç»Ÿæ¦‚è¿°)
- [æ¶æ„å›¾](#æ¶æ„å›¾)
- [æ ¸å¿ƒç»„ä»¶](#æ ¸å¿ƒç»„ä»¶)
- [æ•°æ®æµè¯¦è§£](#æ•°æ®æµè¯¦è§£)
- [å…³é”®ä»£ç ä½ç½®](#å…³é”®ä»£ç ä½ç½®)
- [é—®é¢˜æ’æŸ¥æŒ‡å—](#é—®é¢˜æ’æŸ¥æŒ‡å—)
- [æ—¥å¿—è¯´æ˜](#æ—¥å¿—è¯´æ˜)

---

## ç³»ç»Ÿæ¦‚è¿°

æœ¬é¡¹ç›®ä½¿ç”¨ WebSocket å®ç°å®æ—¶èŠå¤©åŠŸèƒ½ï¼Œé‡‡ç”¨åˆ†å±‚æ¶æ„ï¼š
- **WebSocket ç®¡ç†å™¨å±‚**ï¼šåº•å±‚ WebSocket è¿æ¥ç®¡ç†
- **çŠ¶æ€ç®¡ç†å±‚**ï¼šzustand store ç®¡ç†è¿æ¥çŠ¶æ€å’Œæ¶ˆæ¯
- **ä¸šåŠ¡é€»è¾‘å±‚**ï¼šèŠå¤©åŠŸèƒ½çš„ä¸šåŠ¡å¤„ç†
- **UI å±‚**ï¼šReact ç»„ä»¶å±•ç¤ºå’Œäº¤äº’

---

## æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         åº”ç”¨å¯åŠ¨                              â”‚
â”‚                        App.tsx                               â”‚
â”‚                 è°ƒç”¨ connect() åˆå§‹åŒ–è¿æ¥                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   WebSocket Store                            â”‚
â”‚              src/store/websocketStore.ts                     â”‚
â”‚  â€¢ ç®¡ç†è¿æ¥çŠ¶æ€ (connected/connecting/reconnecting/error)    â”‚
â”‚  â€¢ å­˜å‚¨æ¶ˆæ¯å†å²                                               â”‚
â”‚  â€¢ æä¾›æ“ä½œæ–¹æ³• (connect/disconnect/sendMessage)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                      â”‚
             â–¼                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  WebSocket Manager â”‚    â”‚     Chat Store             â”‚
â”‚  src/lib/websocket.tsâ”‚  â”‚  src/store/chatStore.ts    â”‚
â”‚  â€¢ åŸç”Ÿ WebSocket  â”‚    â”‚  â€¢ èŠå¤©æ¶ˆæ¯ç®¡ç†             â”‚
â”‚  â€¢ å¿ƒè·³æœºåˆ¶        â”‚    â”‚  â€¢ å‘é€/æ¥æ”¶æ¶ˆæ¯            â”‚
â”‚  â€¢ è‡ªåŠ¨é‡è¿        â”‚    â”‚  â€¢ æµå¼è¾“å‡ºå¤„ç†             â”‚
â”‚  â€¢ æ¶ˆæ¯æ”¶å‘        â”‚    â”‚  â€¢ å†å²æ¶ˆæ¯åŠ è½½             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                         â”‚
         â”‚                         â”‚
         â–¼                         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   WebSocket é›†æˆ   â”‚    â”‚    UI ç»„ä»¶                  â”‚
â”‚  useWebSocketChat  â”‚â—„â”€â”€â”€â”‚  MessageInput              â”‚
â”‚  Integration.ts    â”‚    â”‚  ChatArea                  â”‚
â”‚  â€¢ ç›‘å¬æ¶ˆæ¯        â”‚    â”‚  MessageLayout             â”‚
â”‚  â€¢ é›†æˆåˆ°èŠå¤©ç³»ç»Ÿ  â”‚    â”‚  â€¢ æ˜¾ç¤ºæ¶ˆæ¯                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â€¢ ç”¨æˆ·è¾“å…¥                 â”‚
                          â”‚  â€¢ è¿æ¥çŠ¶æ€æç¤º             â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒç»„ä»¶

### 1. WebSocket ç®¡ç†å™¨ (`src/lib/websocket.ts`)

**èŒè´£**ï¼š
- ç®¡ç†åŸç”Ÿ WebSocket è¿æ¥
- å®ç°å¿ƒè·³æœºåˆ¶ï¼ˆ30ç§’/æ¬¡ï¼‰
- è‡ªåŠ¨é‡è¿ï¼ˆæœ€å¤š5æ¬¡ï¼‰
- æ¶ˆæ¯æ”¶å‘

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```typescript
class WebSocketManager {
  connect()           // å»ºç«‹è¿æ¥
  disconnect()        // æ–­å¼€è¿æ¥
  send(message)       // å‘é€æ¶ˆæ¯
  isConnected()       // æ£€æŸ¥è¿æ¥çŠ¶æ€
  setCallbacks()      // è®¾ç½®äº‹ä»¶å›è°ƒ
}
```

**å…³é”®ç‰¹æ€§**ï¼š
- å•ä¾‹æ¨¡å¼ï¼Œå…¨å±€å”¯ä¸€å®ä¾‹
- è‡ªåŠ¨ JSON è§£æ/åºåˆ—åŒ–
- æ”¯æŒçº¯æ–‡æœ¬å’Œç»“æ„åŒ–æ¶ˆæ¯
- å¿ƒè·³è¶…æ—¶æ£€æµ‹ï¼ˆ10ç§’ï¼‰

---

### 2. WebSocket Store (`src/store/websocketStore.ts`)

**èŒè´£**ï¼š
- ç®¡ç† WebSocket è¿æ¥çŠ¶æ€
- å­˜å‚¨æ¶ˆæ¯å†å²ï¼ˆæœ€å¤š1000æ¡ï¼‰
- æä¾› React Hook æ¥å£
- åŒæ­¥çŠ¶æ€åˆ° UI

**æ ¸å¿ƒçŠ¶æ€**ï¼š
```typescript
{
  connectionStatus: 'connected' | 'connecting' | 'reconnecting' | 'error' | 'disconnected'
  isConnected: boolean
  messageHistory: WebSocketMessage[]
  lastMessage: WebSocketMessage | null
  error: string | null
}
```

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```typescript
connect(config?)           // è¿æ¥
disconnect()               // æ–­å¼€
sendMessage(message)       // å‘é€æ¶ˆæ¯
sendChatMessage()          // å‘é€èŠå¤©æ¶ˆæ¯
syncStatus()              // åŒæ­¥çŠ¶æ€
```

**React Hooks**ï¼š
```typescript
useWebSocketConnection()   // è·å–è¿æ¥çŠ¶æ€
useWebSocketMessages()     // è·å–æ¶ˆæ¯å†å²
useWebSocketActions()      // è·å–æ“ä½œæ–¹æ³•
useChatMessages(agentId)  // è·å–æŒ‡å®š Agent çš„èŠå¤©æ¶ˆæ¯
```

---

### 3. Chat Store (`src/store/chatStore.ts`)

**èŒè´£**ï¼š
- ç®¡ç†èŠå¤©æ¶ˆæ¯ï¼ˆUI å±‚é¢ï¼‰
- å¤„ç†æ¶ˆæ¯å‘é€é€»è¾‘
- å¤„ç†æµå¼è¾“å‡º
- åŠ è½½å†å²æ¶ˆæ¯

**æ ¸å¿ƒæ–¹æ³•**ï¼š
```typescript
sendMessage()              // å‘é€æ¶ˆæ¯
handleReceiveMessage()     // å¤„ç†æ¥æ”¶çš„æ¶ˆæ¯
addHistoryMessages()       // æ·»åŠ å†å²æ¶ˆæ¯
updateMessage()            // æ›´æ–°æ¶ˆæ¯å†…å®¹ï¼ˆæµå¼è¾“å‡ºï¼‰
```

---

### 4. WebSocket é›†æˆ Hook (`src/hooks/useWebSocketChatIntegration.ts`)

**èŒè´£**ï¼š
- ç›‘å¬ WebSocket æ¶ˆæ¯
- è¿‡æ»¤èŠå¤©æ¶ˆæ¯
- è°ƒç”¨ chatStore å¤„ç†æ¶ˆæ¯

**å·¥ä½œæµç¨‹**ï¼š
```typescript
lastMessage å˜åŒ– 
  â†’ æ£€æŸ¥æ¶ˆæ¯ç±»å‹ 
  â†’ å¦‚æœæ˜¯èŠå¤©æ¶ˆæ¯ 
  â†’ è°ƒç”¨ chatStore.handleReceiveMessage()
```

---

### 5. è¿æ¥ç¡®ä¿ Hook (`src/hooks/useEnsureWebSocketConnected.ts`)

**èŒè´£**ï¼š
- åœ¨ç»„ä»¶åŠ è½½æ—¶ç¡®ä¿ WebSocket å·²è¿æ¥
- è‡ªåŠ¨åŒæ­¥çŠ¶æ€
- å‰3ç§’å®šæœŸæ£€æŸ¥ï¼ˆ500ms/æ¬¡ï¼‰

**ä½¿ç”¨åœºæ™¯**ï¼š
- MessageInput ç»„ä»¶
- MessageLayout ç»„ä»¶

---

## æ•°æ®æµè¯¦è§£

### ğŸ“¤ å‘é€æ¶ˆæ¯æµç¨‹

```
ç”¨æˆ·è¾“å…¥æ¶ˆæ¯ â†’ ç‚¹å‡»å‘é€
         â”‚
         â–¼
MessageInput ç»„ä»¶
         â”‚
         â–¼
chatStore.sendMessage()
         â”‚
         â”œâ”€ 1. éªŒè¯ï¼šæ£€æŸ¥æ¶ˆæ¯ã€Agentã€ä¼šè¯ID
         â”œâ”€ 2. æ£€æŸ¥ï¼šWebSocket è¿æ¥çŠ¶æ€
         â”œâ”€ 3. æ·»åŠ ï¼šç”¨æˆ·æ¶ˆæ¯åˆ° UI
         â”œâ”€ 4. åˆ›å»ºï¼šAI æ¶ˆæ¯å ä½ç¬¦ï¼ˆstreaming=trueï¼‰
         â”œâ”€ 5. æ„å»ºï¼šWebSocket æ¶ˆæ¯
         â”‚     {
         â”‚       type: 'chat_message',
         â”‚       message: {
         â”‚         data: { content: '...' },
         â”‚         id: '...',
         â”‚         agent_uuid: '...',
         â”‚         conversation_uuid: '...'
         â”‚       }
         â”‚     }
         â–¼
wsStore.sendMessage(wsMessage)
         â”‚
         â–¼
WebSocketManager.send()
         â”‚
         â–¼
é€šè¿‡ WebSocket å‘é€åˆ°æœåŠ¡å™¨
```

**å…³é”®ä»£ç **ï¼š
```typescript
// src/store/chatStore.ts:143-159
const wsMessage: SendChatMessage = {
  type: 'chat_message',
  message: {
    data: { content: currentMessage.trim() },
    id: Date.now().toString(),
    agent_uuid: selectedAgent,
    conversation_uuid: conversationId
  }
};
wsStore.sendMessage(wsMessage);
```

---

### ğŸ“¥ æ¥æ”¶æ¶ˆæ¯æµç¨‹

```
æœåŠ¡å™¨å‘é€æ¶ˆæ¯
         â”‚
         â–¼
WebSocketManager.onmessage
         â”‚
         â”œâ”€ 1. è§£æï¼šJSON.parse(data)
         â”œâ”€ 2. éªŒè¯ï¼šæ¶ˆæ¯æ ¼å¼
         â”œâ”€ 3. å¿ƒè·³ï¼šæ£€æŸ¥æ˜¯å¦æ˜¯ pong
         â”‚     â””â”€ æ˜¯ â†’ æ¸…é™¤å¿ƒè·³è¶…æ—¶
         â””â”€ 4. å›è°ƒï¼šè§¦å‘ onMessage
                â”‚
                â–¼
wsStore å›è°ƒ â†’ æ·»åŠ åˆ° messageHistory
                â”‚
                â–¼
useWebSocketChatIntegration ç›‘å¬ lastMessage
                â”‚
                â”œâ”€ 1. æ£€æŸ¥ï¼šæ˜¯å¦æ˜¯èŠå¤©æ¶ˆæ¯
                â”‚     - type === 'chat_message'
                â”‚     - status in ['finish', 'error', 'pending']
                â”œâ”€ 2. è¿‡æ»¤ï¼šéèŠå¤©æ¶ˆæ¯è·³è¿‡
                â””â”€ 3. è°ƒç”¨ï¼šchatStore.handleReceiveMessage()
                        â”‚
                        â–¼
chatStore.handleReceiveMessage()
                        â”‚
                        â”œâ”€ 1. æŸ¥æ‰¾ï¼šæµå¼æ¶ˆæ¯å ä½ç¬¦
                        â”œâ”€ 2. æå–ï¼šæ¶ˆæ¯å†…å®¹
                        â”œâ”€ 3. æ›´æ–°ï¼š
                        â”‚     - pending â†’ è¿½åŠ å†…å®¹
                        â”‚     - finish â†’ åœæ­¢æµå¼è¾“å‡º
                        â”‚     - error â†’ æ˜¾ç¤ºé”™è¯¯
                        â””â”€ 4. åˆ·æ–°ï¼šUI æ˜¾ç¤º
```

**å…³é”®ä»£ç **ï¼š
```typescript
// src/store/chatStore.ts:256-340
handleReceiveMessage: (wsMessage: ReceiveChatMessage) => {
  // æŸ¥æ‰¾æµå¼æ¶ˆæ¯å ä½ç¬¦
  const streamingMessage = state.messages.find(
    m => m.role === 'assistant' && 
         m.isStreaming && 
         m.agentId === state.selectedAgent
  );
  
  // æ ¹æ®çŠ¶æ€å¤„ç†
  if (wsMessage.status === 'pending') {
    // è¿½åŠ å†…å®¹
  } else if (wsMessage.status === 'finish') {
    // å®Œæˆæµå¼è¾“å‡º
  } else if (wsMessage.status === 'error') {
    // æ˜¾ç¤ºé”™è¯¯
  }
}
```

---

### ğŸ”„ è¿æ¥å»ºç«‹æµç¨‹

```
åº”ç”¨å¯åŠ¨
    â”‚
    â–¼
App.tsx useEffect
    â”‚
    â””â”€ connect() â”€â”€â”€â”€â”€â”€â”
                       â”‚
                       â–¼
            wsStore.connect()
                       â”‚
                       â”œâ”€ 1. æ£€æŸ¥ï¼šæ˜¯å¦å·²è¿æ¥
                       â”œâ”€ 2. åˆ›å»ºï¼šWebSocketManager å®ä¾‹
                       â”œâ”€ 3. è®¾ç½®ï¼šäº‹ä»¶å›è°ƒ
                       â”‚     - onOpen â†’ æ›´æ–°çŠ¶æ€ä¸º 'connected'
                       â”‚     - onClose â†’ æ›´æ–°çŠ¶æ€ä¸º 'disconnected'
                       â”‚     - onError â†’ æ›´æ–°çŠ¶æ€ä¸º 'error'
                       â”‚     - onMessage â†’ æ·»åŠ åˆ°æ¶ˆæ¯å†å²
                       â””â”€ 4. è¿æ¥ï¼šwsManager.connect()
                                   â”‚
                                   â–¼
                       WebSocketManager.connect()
                                   â”‚
                                   â”œâ”€ 1. è®¾ç½®çŠ¶æ€ï¼š'connecting'
                                   â”œâ”€ 2. åˆ›å»ºï¼šnew WebSocket(url)
                                   â”œâ”€ 3. ç›‘å¬ï¼šonopen/onclose/onerror/onmessage
                                   â””â”€ 4. æˆåŠŸï¼š
                                         â”œâ”€ è®¾ç½®çŠ¶æ€ï¼š'connected'
                                         â”œâ”€ è§¦å‘ï¼šonOpen å›è°ƒ
                                         â””â”€ å¯åŠ¨ï¼šå¿ƒè·³æœºåˆ¶
```

---

### ğŸ’“ å¿ƒè·³æœºåˆ¶

```
è¿æ¥æˆåŠŸ
    â”‚
    â–¼
å¯åŠ¨å¿ƒè·³å®šæ—¶å™¨ï¼ˆ30ç§’ï¼‰
    â”‚
    â””â”€ æ¯ 30 ç§’ â”€â”€â”
                  â”‚
                  â–¼
       å‘é€å¿ƒè·³æ¶ˆæ¯
       {
         type: 'heartbeat',
         message: { data: { content: 'ping' } }
       }
                  â”‚
                  â”œâ”€ è®¾ç½®ï¼š10ç§’è¶…æ—¶å®šæ—¶å™¨
                  â”‚
                  â”œâ”€ æ”¶åˆ° pong â”€â”€â†’ æ¸…é™¤è¶…æ—¶å®šæ—¶å™¨ â”€â”€â†’ ç»§ç»­
                  â”‚
                  â””â”€ è¶…æ—¶ â”€â”€â†’ å…³é—­è¿æ¥ â”€â”€â†’ è§¦å‘é‡è¿
```

---

### ğŸ”„ è‡ªåŠ¨é‡è¿æµç¨‹

```
è¿æ¥å…³é—­/é”™è¯¯
    â”‚
    â–¼
æ£€æŸ¥ï¼šæ˜¯å¦ä¸»åŠ¨å…³é—­
    â”‚
    â”œâ”€ æ˜¯ï¼ˆcode=1000ï¼‰â”€â”€â†’ åœæ­¢
    â”‚
    â””â”€ å¦ â”€â”€â†’ æ£€æŸ¥é‡è¿æ¬¡æ•°
              â”‚
              â”œâ”€ < 5 æ¬¡ â”€â”€â†’ å®‰æ’é‡è¿
              â”‚            â”‚
              â”‚            â””â”€ 3 ç§’å â”€â”€â†’ é‡æ–°è¿æ¥
              â”‚                         â”‚
              â”‚                         â””â”€ é‡è¿æ¬¡æ•° +1
              â”‚
              â””â”€ â‰¥ 5 æ¬¡ â”€â”€â†’ åœæ­¢é‡è¿
                          â”‚
                          â””â”€ è®¾ç½®çŠ¶æ€ï¼š'error'
```

---

## å…³é”®ä»£ç ä½ç½®

### é…ç½®æ–‡ä»¶
| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `.env` | WebSocket æœåŠ¡å™¨åœ°å€é…ç½® |
| `src/types/websocket.ts` | WebSocket åŸºç¡€ç±»å‹å®šä¹‰ |
| `src/types/chat-websocket.ts` | èŠå¤©æ¶ˆæ¯ç±»å‹å®šä¹‰ |

### æ ¸å¿ƒé€»è¾‘
| æ–‡ä»¶ | è¯´æ˜ | å…³é”®è¡Œå· |
|------|------|---------|
| `src/lib/websocket.ts` | WebSocket ç®¡ç†å™¨ | 75:è¿æ¥, 200:äº‹ä»¶ç›‘å¬, 365:å¿ƒè·³ |
| `src/store/websocketStore.ts` | WebSocket çŠ¶æ€ç®¡ç† | 89:è¿æ¥æ–¹æ³•, 232:å‘é€æ¶ˆæ¯ |
| `src/store/chatStore.ts` | èŠå¤©é€»è¾‘ | 87:å‘é€æ¶ˆæ¯, 256:æ¥æ”¶æ¶ˆæ¯ |

### UI ç»„ä»¶
| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `src/components/MessageInput.tsx` | æ¶ˆæ¯è¾“å…¥æ¡† |
| `src/components/ChatArea.tsx` | èŠå¤©æ¶ˆæ¯æ˜¾ç¤º |
| `src/components/layout/MessageLayout.tsx` | æ¶ˆæ¯é¡µé¢å¸ƒå±€ |

### Hooks
| æ–‡ä»¶ | è¯´æ˜ |
|------|------|
| `src/hooks/useWebSocketChatIntegration.ts` | WebSocket æ¶ˆæ¯é›†æˆ |
| `src/hooks/useEnsureWebSocketConnected.ts` | ç¡®ä¿è¿æ¥ |

---

## é—®é¢˜æ’æŸ¥æŒ‡å—

### é—®é¢˜ 1ï¼šæ— æ³•è¿æ¥

**ç—‡çŠ¶**ï¼šçŠ¶æ€ä¸€ç›´æ˜¾ç¤º"è¿æ¥ä¸­"æˆ–"é‡è¿ä¸­"

**æ’æŸ¥æ­¥éª¤**ï¼š
1. **æ£€æŸ¥ WebSocket æœåŠ¡å™¨**
   ```bash
   # æµ‹è¯•æœåŠ¡å™¨æ˜¯å¦å¯è¾¾
   telnet 192.168.10.19 8001
   ```

2. **æ£€æŸ¥ç¯å¢ƒå˜é‡**
   ```bash
   # .env æ–‡ä»¶
   VITE_WS_URL=ws://192.168.10.19:8001/api/v1/websocket/user/[userId]
   ```

3. **æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—**
   - æœç´¢ï¼š`âŒ [WebSocket è¿æ¥é”™è¯¯]`
   - æŸ¥çœ‹é”™è¯¯è¯¦æƒ…

4. **æ£€æŸ¥ç½‘ç»œ**
   - é˜²ç«å¢™è®¾ç½®
   - ä»£ç†é…ç½®
   - CORS ç­–ç•¥

**ç›¸å…³ä»£ç **ï¼š
- `src/store/websocketStore.ts:32-58` - åœ°å€é…ç½®
- `src/lib/websocket.ts:75-105` - è¿æ¥é€»è¾‘

---

### é—®é¢˜ 2ï¼šè¿æ¥æˆåŠŸä½†çŠ¶æ€æ˜¾ç¤ºä¸å¯¹

**ç—‡çŠ¶**ï¼šèƒ½æ”¶åˆ°æ¶ˆæ¯ï¼ˆæ§åˆ¶å°æœ‰æ—¥å¿—ï¼‰ï¼Œä½† UI æ˜¾ç¤º"æœªè¿æ¥"

**æ’æŸ¥æ­¥éª¤**ï¼š
1. **æ£€æŸ¥çŠ¶æ€åŒæ­¥**
   - æ§åˆ¶å°æœç´¢ï¼š`ğŸ”„ [Store] åŒæ­¥ WebSocket çŠ¶æ€`
   - æŸ¥çœ‹ `ç®¡ç†å™¨çŠ¶æ€` å’Œ `æ˜¯å¦è¿æ¥` æ˜¯å¦ä¸€è‡´

2. **å¼ºåˆ¶åŒæ­¥çŠ¶æ€**
   - åœ¨æ§åˆ¶å°æ‰§è¡Œï¼š
     ```javascript
     useWebSocketStore.getState().syncStatus()
     ```

3. **æ£€æŸ¥å›è°ƒè®¾ç½®**
   - æ§åˆ¶å°æœç´¢ï¼š`ğŸ”§ [WebSocket] è®¾ç½®äº‹ä»¶å›è°ƒ`
   - ç¡®è®¤åŒ…å«ï¼š`onOpen`, `onClose`, `onError`, `onMessage`

**ç›¸å…³ä»£ç **ï¼š
- `src/hooks/useEnsureWebSocketConnected.ts:17-40` - è‡ªåŠ¨åŒæ­¥
- `src/store/websocketStore.ts:319-339` - syncStatus æ–¹æ³•

---

### é—®é¢˜ 3ï¼šå‘é€æ¶ˆæ¯å¤±è´¥

**ç—‡çŠ¶**ï¼šç‚¹å‡»å‘é€åæç¤º"WebSocketæœªè¿æ¥"æˆ–æ— ååº”

**æ’æŸ¥æ­¥éª¤**ï¼š
1. **æ£€æŸ¥è¿æ¥çŠ¶æ€**
   ```javascript
   useWebSocketStore.getState().isConnected  // åº”è¯¥ä¸º true
   ```

2. **æ£€æŸ¥ Agent å’Œä¼šè¯ ID**
   ```javascript
   useChatStore.getState().selectedAgent      // ä¸èƒ½ä¸ºç©º
   useChatStore.getState().conversationId     // ä¸èƒ½ä¸º null
   ```

3. **æŸ¥çœ‹å‘é€æ—¥å¿—**
   - æ§åˆ¶å°æœç´¢ï¼š`ğŸ“¤ [ChatStore] å‘é€WebSocketæ¶ˆæ¯`
   - æ£€æŸ¥æ¶ˆæ¯ç»“æ„æ˜¯å¦æ­£ç¡®

4. **æ£€æŸ¥æ¶ˆæ¯æ ¼å¼**
   ```javascript
   {
     type: 'chat_message',
     message: {
       data: { content: '...' },
       id: '...',
       agent_uuid: '...',
       conversation_uuid: '...'
     }
   }
   ```

**ç›¸å…³ä»£ç **ï¼š
- `src/store/chatStore.ts:87-180` - å‘é€æ¶ˆæ¯é€»è¾‘
- `src/types/chat-websocket.ts:15-31` - æ¶ˆæ¯ç±»å‹å®šä¹‰

---

### é—®é¢˜ 4ï¼šæ”¶ä¸åˆ°æ¶ˆæ¯æˆ–æ¶ˆæ¯ä¸æ˜¾ç¤º

**ç—‡çŠ¶**ï¼šæœåŠ¡å™¨å‘é€äº†æ¶ˆæ¯ï¼Œä½† UI ä¸æ˜¾ç¤º

**æ’æŸ¥æ­¥éª¤**ï¼š
1. **æ£€æŸ¥ WebSocket æ¶ˆæ¯**
   - å¼€å‘è€…å·¥å…· â†’ Network â†’ WS
   - æŸ¥çœ‹ Messages æ ‡ç­¾
   - ç¡®è®¤æ”¶åˆ°äº†æ¶ˆæ¯

2. **æ£€æŸ¥æ¶ˆæ¯æ ¼å¼**
   - æ§åˆ¶å°æœç´¢ï¼š`ğŸ“¥ [WebSocket æ¥æ”¶æ¶ˆæ¯]`
   - ç¡®è®¤æ¶ˆæ¯ç±»å‹æ˜¯ `chat_message`
   - ç¡®è®¤ status æ˜¯ `pending`/`finish`/`error`

3. **æ£€æŸ¥æ¶ˆæ¯é›†æˆ**
   - æ§åˆ¶å°æœç´¢ï¼š`ğŸ”— [WebSocket Chat Integration]`
   - ç¡®è®¤ `æ˜¯å¦æ˜¯èŠå¤©æ¶ˆæ¯` ä¸º `true`
   - ç¡®è®¤è°ƒç”¨äº† `handleReceiveMessage`

4. **æ£€æŸ¥æ¶ˆæ¯å¤„ç†**
   - æ§åˆ¶å°æœç´¢ï¼š`ğŸ“¦ [ChatStore] æ¥æ”¶åˆ°çš„æ¶ˆæ¯`
   - ç¡®è®¤æ‰¾åˆ°äº†æµå¼æ¶ˆæ¯å ä½ç¬¦
   - ç¡®è®¤æ¶ˆæ¯è¢«æ·»åŠ åˆ°äº† messages

**ç›¸å…³ä»£ç **ï¼š
- `src/lib/websocket.ts:255-326` - æ¶ˆæ¯æ¥æ”¶
- `src/hooks/useWebSocketChatIntegration.ts:24-74` - æ¶ˆæ¯é›†æˆ
- `src/store/chatStore.ts:256-340` - æ¶ˆæ¯å¤„ç†

---

### é—®é¢˜ 5ï¼šæµå¼è¾“å‡ºä¸å·¥ä½œ

**ç—‡çŠ¶**ï¼šæ¶ˆæ¯ä¸€æ¬¡æ€§æ˜¾ç¤ºï¼Œæ²¡æœ‰é€å­—è¾“å‡º

**æ’æŸ¥æ­¥éª¤**ï¼š
1. **æ£€æŸ¥åç«¯æ˜¯å¦æ”¯æŒæµå¼è¾“å‡º**
   - åç«¯åº”è¯¥åˆ†å¤šæ¬¡å‘é€ status='pending' çš„æ¶ˆæ¯
   - æœ€åå‘é€ status='finish' çš„æ¶ˆæ¯

2. **æ£€æŸ¥æ¶ˆæ¯å ä½ç¬¦**
   - æ§åˆ¶å°æœç´¢ï¼š`ğŸ” æŸ¥æ‰¾æµå¼æ¶ˆæ¯å ä½ç¬¦`
   - ç¡®è®¤æ‰¾åˆ°äº† `isStreaming=true` çš„æ¶ˆæ¯

3. **æ£€æŸ¥å†…å®¹è¿½åŠ **
   - æ§åˆ¶å°æœç´¢ï¼š`ğŸ“ [ChatStore] è¿½åŠ æ¶ˆæ¯å†…å®¹`
   - ç¡®è®¤æ¯æ¬¡ pending çŠ¶æ€éƒ½åœ¨è¿½åŠ å†…å®¹

4. **æ£€æŸ¥å®Œæˆæ ‡è®°**
   - æ§åˆ¶å°æœç´¢ï¼š`âœ… [ChatStore] æ¶ˆæ¯æ¥æ”¶å®Œæˆ`
   - ç¡®è®¤æ”¶åˆ° finish çŠ¶æ€

**ç›¸å…³ä»£ç **ï¼š
- `src/store/chatStore.ts:280-335` - æµå¼è¾“å‡ºå¤„ç†

---

## æ—¥å¿—è¯´æ˜

### å…³é”®æ—¥å¿—æ ‡è¯†

| æ—¥å¿—å‰ç¼€ | ä½ç½® | è¯´æ˜ |
|---------|------|------|
| `ğŸ‰ [WebSocket è¿æ¥æˆåŠŸ]` | websocket.ts | è¿æ¥å»ºç«‹æˆåŠŸ |
| `ğŸ”Œ [WebSocket è¿æ¥å…³é—­]` | websocket.ts | è¿æ¥å…³é—­ |
| `âŒ [WebSocket è¿æ¥é”™è¯¯]` | websocket.ts | è¿æ¥é”™è¯¯ |
| `ğŸ“¤ [ChatStore] å‘é€WebSocketæ¶ˆæ¯` | chatStore.ts | å‘é€æ¶ˆæ¯ |
| `ğŸ“¥ [WebSocket æ¥æ”¶æ¶ˆæ¯]` | websocket.ts | æ¥æ”¶æ¶ˆæ¯ |
| `ğŸ”— [WebSocket Chat Integration]` | useWebSocketChatIntegration.ts | æ¶ˆæ¯é›†æˆ |
| `ğŸ“¦ [ChatStore] æ¥æ”¶åˆ°çš„æ¶ˆæ¯` | chatStore.ts | å¤„ç†æ¥æ”¶æ¶ˆæ¯ |
| `ğŸ’“ [WebSocket å¿ƒè·³]` | websocket.ts | å¿ƒè·³ç›¸å…³ |
| `ğŸ”„ [Store] åŒæ­¥ WebSocket çŠ¶æ€` | websocketStore.ts | çŠ¶æ€åŒæ­¥ |

### æ—¥å¿—çº§åˆ«

- **ğŸ‰ æˆåŠŸ**ï¼šç»¿è‰²ï¼Œæ­£å¸¸æ“ä½œæˆåŠŸ
- **ğŸ“¤ğŸ“¥ ä¿¡æ¯**ï¼šè“è‰²ï¼Œæ¶ˆæ¯æ”¶å‘
- **âš ï¸ è­¦å‘Š**ï¼šé»„è‰²ï¼Œéè‡´å‘½é—®é¢˜
- **âŒ é”™è¯¯**ï¼šçº¢è‰²ï¼Œéœ€è¦å¤„ç†çš„é”™è¯¯

### å¦‚ä½•ä½¿ç”¨æ—¥å¿—æ’æŸ¥é—®é¢˜

1. **è¿æ¥é—®é¢˜**ï¼šæœç´¢ `[WebSocket è¿æ¥]`
2. **å‘é€é—®é¢˜**ï¼šæœç´¢ `ğŸ“¤ [ChatStore]`
3. **æ¥æ”¶é—®é¢˜**ï¼šæœç´¢ `ğŸ“¥ [WebSocket æ¥æ”¶]` å’Œ `ğŸ”— [WebSocket Chat Integration]`
4. **çŠ¶æ€é—®é¢˜**ï¼šæœç´¢ `ğŸ”„ [Store] åŒæ­¥`
5. **å¿ƒè·³é—®é¢˜**ï¼šæœç´¢ `ğŸ’“ [WebSocket å¿ƒè·³]`

---

## ç¯å¢ƒå˜é‡é…ç½®

### `.env` æ–‡ä»¶

```bash
# WebSocket æœåŠ¡å™¨åœ°å€
VITE_WS_URL=ws://192.168.10.19:8001/api/v1/websocket/user/97772489-34af-4179-83ca-00993b382605

# å¼€å‘ç¯å¢ƒæ ‡è¯†
VITE_NODE_ENV=development
```

**æ³¨æ„**ï¼š
- ä¿®æ”¹ `.env` åéœ€è¦é‡å¯å¼€å‘æœåŠ¡å™¨
- ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ `wss://` åè®®ï¼ˆåŠ å¯†ï¼‰

---

## æœ€ä½³å®è·µ

1. **è¿æ¥ç®¡ç†**
   - åº”ç”¨å¯åŠ¨æ—¶è‡ªåŠ¨è¿æ¥
   - ç»„ä»¶å¸è½½æ—¶ä¸æ–­å¼€ï¼ˆç”±ç®¡ç†å™¨ç»Ÿä¸€ç®¡ç†ï¼‰
   - ä½¿ç”¨ `useEnsureWebSocketConnected` ç¡®ä¿è¿æ¥

2. **æ¶ˆæ¯å‘é€**
   - å‘é€å‰æ£€æŸ¥è¿æ¥çŠ¶æ€
   - éªŒè¯ Agent å’Œä¼šè¯ ID
   - ä½¿ç”¨ç±»å‹å®‰å…¨çš„æ¶ˆæ¯ç»“æ„

3. **é”™è¯¯å¤„ç†**
   - æ•è·æ‰€æœ‰ WebSocket é”™è¯¯
   - æä¾›ç”¨æˆ·å‹å¥½çš„é”™è¯¯æç¤º
   - è‡ªåŠ¨é‡è¿æœºåˆ¶

4. **æ€§èƒ½ä¼˜åŒ–**
   - æ¶ˆæ¯å†å²é™åˆ¶ 1000 æ¡
   - ä½¿ç”¨ React.memo ä¼˜åŒ–ç»„ä»¶æ¸²æŸ“
   - åˆç†ä½¿ç”¨ useMemo/useCallback

---

## æŠ€æœ¯æ ˆ

- **WebSocket**ï¼šåŸç”Ÿ WebSocket API
- **çŠ¶æ€ç®¡ç†**ï¼šzustand
- **TypeScript**ï¼šç±»å‹å®‰å…¨
- **React Hooks**ï¼šå‡½æ•°å¼ç»„ä»¶
- **å•ä¾‹æ¨¡å¼**ï¼šWebSocket ç®¡ç†å™¨

---

## æ›´æ–°æ—¥å¿—

- **2025-09-30**ï¼šåˆ›å»ºæ–‡æ¡£ï¼Œè¯¦ç»†è¯´æ˜æ•°æ®æµå’Œé—®é¢˜æ’æŸ¥
