# 路由代码组织规范

## 🎯 核心原则

在双层 Features 架构下，路由代码采用**分层组织**策略：

```
全局路由配置（应用级）
    ↓
业务模块路由（功能级）
    ↓
具体页面组件
```

---

## 📁 路由代码放置位置

### 1. 全局路由配置 - `src/app/router.tsx` ✅

**职责**：应用级路由配置和路由组合

```typescript
// ✅ src/app/router.tsx - 全局路由配置
import { createBrowserRouter } from 'react-router-dom'
import App from '@/App'

// 导入各业务模块的路由
import { chatRoutes } from '@/business-features/chat/routes'
import { agentsRoutes } from '@/business-features/agents/routes'
import { contactsRoutes } from '@/business-features/contacts/routes'
import { analyticsRoutes } from '@/business-features/analytics/routes'

export const router = createBrowserRouter([
  {
    path: '/',
    element: <App />,
    children: [
      // 组合各业务模块的路由
      ...chatRoutes,
      ...agentsRoutes,
      ...contactsRoutes,
      ...analyticsRoutes,
      
      // 全局路由（如 404）
      {
        path: '*',
        element: <NotFound />
      }
    ]
  }
])
```

#### 全局路由配置内容

| 文件 | 职责 | 典型内容 |
|------|------|---------|
| `src/app/router.tsx` | 路由组合和配置 | 路由器创建、路由组合、全局路由（404、登录） |
| `src/app/provider.tsx` | 全局 Provider | RouterProvider、ThemeProvider、I18nProvider |
| `src/app/index.tsx` | 应用入口 | App 组件导出 |

---

### 2. 业务模块路由 - `src/business-features/[feature]/routes/` ✅

**职责**：各业务功能的完整路由定义

#### 目录结构

```
src/business-features/
├── chat/
│   ├── routes/
│   │   ├── index.ts          # 导出路由配置
│   │   ├── ChatRoutes.tsx    # 路由定义（可选）
│   │   └── routeConfig.ts    # 路由元数据（可选）
│   ├── pages/
│   │   ├── ChatPage.tsx      # 聊天页面
│   │   ├── ChatHistory.tsx   # 历史记录页面
│   │   └── index.ts
│   └── ...
│
├── agents/
│   ├── routes/
│   │   └── index.ts
│   ├── pages/
│   │   ├── AgentsPage.tsx
│   │   ├── AgentDetail.tsx
│   │   └── index.ts
│   └── ...
```

#### 业务模块路由示例

```typescript
// ✅ src/business-features/chat/routes/index.ts
import { RouteObject } from 'react-router-dom'
import { ChatPage } from '../pages/ChatPage'
import { ChatHistory } from '../pages/ChatHistory'

// 导出聊天模块的路由配置
export const chatRoutes: RouteObject[] = [
  {
    path: '/chat',
    element: <ChatPage />,
    children: [
      {
        path: ':conversationId',
        element: <ChatPage />
      }
    ]
  },
  {
    path: '/chat/history',
    element: <ChatHistory />
  }
]

// 路由元数据（可选）
export const chatRouteMeta = {
  basePath: '/chat',
  title: 'chat.title',
  icon: 'MessageSquare',
  requiresAuth: true
}
```

```typescript
// ✅ src/business-features/agents/routes/index.ts
import { RouteObject } from 'react-router-dom'
import { AgentsPage } from '../pages/AgentsPage'
import { AgentDetail } from '../pages/AgentDetail'

export const agentsRoutes: RouteObject[] = [
  {
    path: '/agents',
    element: <AgentsPage />
  },
  {
    path: '/agents/:agentId',
    element: <AgentDetail />
  }
]

export const agentsRouteMeta = {
  basePath: '/agents',
  title: 'agents.title',
  icon: 'Bot',
  requiresAuth: true
}
```

---

### 3. 页面组件 - `src/business-features/[feature]/pages/` ✅

**职责**：具体的页面级组件

```typescript
// ✅ src/business-features/chat/pages/ChatPage.tsx
import { useParams } from 'react-router-dom'
import { ChatArea, ConversationList } from '../components'

export const ChatPage = () => {
  const { conversationId } = useParams()
  
  return (
    <div className="flex h-full bg-background">
      <ConversationList />
      <ChatArea conversationId={conversationId} />
    </div>
  )
}
```

```typescript
// ✅ src/business-features/chat/pages/index.ts
export { ChatPage } from './ChatPage'
export { ChatHistory } from './ChatHistory'
```

---

### 4. 路由工具和类型 - `src/types/router.ts` ✅

**职责**：全局路由相关的类型定义和工具函数

```typescript
// ✅ src/types/router.ts - 全局路由类型
import { RouteObject } from 'react-router-dom'

// 路由元数据类型
export interface RouteMeta {
  basePath: string
  title: string
  icon?: string
  requiresAuth?: boolean
  roles?: string[]
}

// 扩展的路由对象
export interface AppRouteObject extends RouteObject {
  meta?: RouteMeta
  children?: AppRouteObject[]
}

// 路由配置类型
export interface RouteConfig {
  routes: RouteObject[]
  meta?: RouteMeta
}

// 导航项类型
export interface NavigationItem {
  path: string
  label: string
  icon?: string
  children?: NavigationItem[]
}
```

---

## 📊 路由代码分布图

```
src/
├── app/                                    # 应用级配置 (10%)
│   ├── router.tsx                         # ✅ 全局路由组合
│   ├── provider.tsx                       # ✅ 全局 Provider
│   └── index.tsx                          # ✅ 应用入口
│
├── business-features/                     # 业务模块 (80%)
│   ├── chat/
│   │   ├── routes/                       # ✅ 聊天路由
│   │   │   └── index.ts                  # 路由配置导出
│   │   ├── pages/                        # ✅ 聊天页面
│   │   │   ├── ChatPage.tsx
│   │   │   ├── ChatHistory.tsx
│   │   │   └── index.ts
│   │   └── ...
│   │
│   ├── agents/
│   │   ├── routes/                       # ✅ Agents 路由
│   │   ├── pages/                        # ✅ Agents 页面
│   │   └── ...
│   │
│   ├── contacts/
│   │   ├── routes/                       # ✅ 联系人路由
│   │   ├── pages/                        # ✅ 联系人页面
│   │   └── ...
│   │
│   └── analytics/
│       ├── routes/                       # ✅ 分析路由
│       ├── pages/                        # ✅ 分析页面
│       └── ...
│
├── components/                            # 全局组件
│   └── layout/
│       ├── AppLayout.tsx                 # 应用布局
│       └── NotFound.tsx                  # 404 页面
│
└── types/                                 # 全局类型 (10%)
    └── router.ts                         # ✅ 路由类型定义
```

---

## 🎯 实际案例对比

### 案例 1：聊天功能的路由组织

#### ❌ 错误：路由集中在全局

```typescript
// ❌ src/app/router.tsx - 所有路由都写在这里
export const router = createBrowserRouter([
  {
    path: '/',
    element: <App />,
    children: [
      // 聊天路由
      { path: '/chat', element: <ChatPage /> },
      { path: '/chat/:conversationId', element: <ChatPage /> },
      { path: '/chat/history', element: <ChatHistory /> },
      
      // Agents 路由
      { path: '/agents', element: <AgentsPage /> },
      { path: '/agents/:agentId', element: <AgentDetail /> },
      
      // ... 更多路由（混乱、难维护）
    ]
  }
])
```

**问题**：
- ❌ 所有路由混在一起，难以维护
- ❌ 无法独立管理业务模块的路由
- ❌ 修改聊天功能需要修改全局路由文件

#### ✅ 正确：路由分模块管理

```typescript
// ✅ src/business-features/chat/routes/index.ts
export const chatRoutes: RouteObject[] = [
  {
    path: '/chat',
    element: <ChatPage />,
    children: [
      { path: ':conversationId', element: <ChatPage /> }
    ]
  },
  {
    path: '/chat/history',
    element: <ChatHistory />
  }
]

// ✅ src/app/router.tsx - 简洁的全局路由
import { chatRoutes } from '@/business-features/chat/routes'
import { agentsRoutes } from '@/business-features/agents/routes'

export const router = createBrowserRouter([
  {
    path: '/',
    element: <App />,
    children: [
      ...chatRoutes,      // 聊天路由
      ...agentsRoutes,    // Agents 路由
      // ... 其他模块路由
    ]
  }
])
```

**优势**：
- ✅ 每个业务模块管理自己的路由
- ✅ 全局路由文件简洁清晰
- ✅ 修改聊天路由只需要修改聊天模块

---

### 案例 2：带权限的路由

```typescript
// ✅ src/business-features/agents/routes/index.ts
import { ProtectedRoute } from '@/core-features/auth/components'
import { AgentsPage } from '../pages/AgentsPage'

export const agentsRoutes: RouteObject[] = [
  {
    path: '/agents',
    element: (
      <ProtectedRoute requiredRoles={['admin', 'user']}>
        <AgentsPage />
      </ProtectedRoute>
    )
  }
]

// 路由元数据
export const agentsRouteMeta = {
  basePath: '/agents',
  title: 'agents.title',
  icon: 'Bot',
  requiresAuth: true,
  roles: ['admin', 'user']
}
```

---

### 案例 3：嵌套路由

```typescript
// ✅ src/business-features/analytics/routes/index.ts
import { AnalyticsLayout } from '../components/AnalyticsLayout'
import { Dashboard } from '../pages/Dashboard'
import { Reports } from '../pages/Reports'
import { Charts } from '../pages/Charts'

export const analyticsRoutes: RouteObject[] = [
  {
    path: '/analytics',
    element: <AnalyticsLayout />,
    children: [
      {
        index: true,
        element: <Dashboard />
      },
      {
        path: 'reports',
        element: <Reports />
      },
      {
        path: 'charts',
        element: <Charts />
      }
    ]
  }
]
```

---

## 🔄 路由导航和链接

### 在组件中使用路由

```typescript
// ✅ 使用 react-router-dom 的导航
import { useNavigate, useParams, Link } from 'react-router-dom'

const ChatComponent = () => {
  const navigate = useNavigate()
  const { conversationId } = useParams()
  
  const handleNavigate = () => {
    navigate('/chat/123')
  }
  
  return (
    <div>
      <Link to="/chat" className="text-primary hover:underline">
        返回聊天列表
      </Link>
      <button onClick={handleNavigate}>跳转到会话</button>
    </div>
  )
}
```

### 导航菜单配置

```typescript
// ✅ src/config/navigation.ts - 全局导航配置
import { NavigationItem } from '@/types/router'
import { chatRouteMeta } from '@/business-features/chat/routes'
import { agentsRouteMeta } from '@/business-features/agents/routes'

export const mainNavigation: NavigationItem[] = [
  {
    path: chatRouteMeta.basePath,
    label: chatRouteMeta.title,
    icon: chatRouteMeta.icon
  },
  {
    path: agentsRouteMeta.basePath,
    label: agentsRouteMeta.title,
    icon: agentsRouteMeta.icon
  },
  // ... 其他导航项
]
```

---

## ✅ 决策流程图

```
需要创建路由相关代码
          ↓
     是应用级的路由组合？
          ↓
    是 → 放在 src/app/router.tsx
    否 → 继续判断
          ↓
     是特定业务功能的路由？
          ↓
    是 → 放在 src/business-features/[feature]/routes/
    否 → 继续判断
          ↓
     是页面组件？
          ↓
    是 → 放在 src/business-features/[feature]/pages/
    否 → 继续判断
          ↓
     是全局路由类型或工具？
          ↓
    是 → 放在 src/types/router.ts
    否 → 放在 src/config/navigation.ts（导航配置）
```

---

## 📋 检查清单

### 创建新路由前检查

- [ ] **确定是全局路由还是业务路由？**
  - 全局路由 → `src/app/router.tsx`
  - 业务路由 → `src/business-features/[feature]/routes/`

- [ ] **是否需要页面组件？**
  - 需要 → 在 `src/business-features/[feature]/pages/` 创建

- [ ] **是否需要路由守卫（权限）？**
  - 需要 → 使用 `core-features/auth/components/ProtectedRoute`

- [ ] **是否需要路由元数据？**
  - 需要 → 在路由文件中导出 `routeMeta`

- [ ] **是否需要导航菜单配置？**
  - 需要 → 在 `src/config/navigation.ts` 中配置

---

## 🎯 总结

### 路由代码放置位置

| 路由类型 | 放置位置 | 职责 | 示例 |
|---------|---------|------|------|
| **应用级路由** | `src/app/router.tsx` | 路由组合、全局配置 | 路由器创建、404 路由 |
| **业务路由** | `src/business-features/[feature]/routes/` | 业务功能的路由定义 | 聊天路由、Agents 路由 |
| **页面组件** | `src/business-features/[feature]/pages/` | 页面级组件 | ChatPage、AgentsPage |
| **路由类型** | `src/types/router.ts` | 全局路由类型 | RouteMeta、RouteConfig |
| **导航配置** | `src/config/navigation.ts` | 导航菜单配置 | mainNavigation |

### 核心原则

1. **分层管理**：应用级 → 业务级 → 页面级
2. **模块自包含**：每个业务模块管理自己的路由和页面
3. **统一组合**：在应用级统一组合所有路由
4. **类型安全**：使用 TypeScript 确保路由类型安全

**记住：路由配置应该随着功能模块走，不要集中在全局！**

---

**文档版本**: v1.0  
**创建日期**: 2025-10-13  
**维护团队**: IM Agents Web 前端团队

